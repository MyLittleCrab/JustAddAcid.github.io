<!DOCTYPE html><html lang="ru"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Nosoff.info — personal blog"/><title>Использование issues в GitHub как движок комментариев</title><meta property="og:image" content="/assets/blog/issue-comments-github/cover.png"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/8989f9f4657d19f0fcdb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8989f9f4657d19f0fcdb.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dab348d518a0e6702e4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dab348d518a0e6702e4.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/framework-92300432a1172ef1338b.js" defer=""></script><script src="/_next/static/chunks/main-a3a79aff3ff232b41814.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f98b93c1570ecf70d9fa.js" defer=""></script><script src="/_next/static/chunks/853-ae4f3fbc7686be6d8798.js" defer=""></script><script src="/_next/static/chunks/260-6a48cb1b1373a113d344.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-ea22828b46c8ab008dde.js" defer=""></script><script src="/_next/static/PBFFKh2g75JrK73wwU0ie/_buildManifest.js" defer=""></script><script src="/_next/static/PBFFKh2g75JrK73wwU0ie/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="min-h-screen"><main><div class="container mx-auto px-5"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8"><a class="hover:underline" href="/">Nosoff.info</a></h2><article class="mb-32"><h1 class="screenreader">Использование issues в GitHub как движок комментариев</h1><div class="hidden md:block md:mb-12"><a class="flex items-center" href="https://github.com/JustAddAcid"><img src="https://avatars3.githubusercontent.com/u/21103635?s=120&amp;v=4" class="w-12 h-12 rounded-full mr-4" alt="Roman A. Nosov"/><div class="text-xl font-bold">Roman A. Nosov</div></a></div><div class="mb-8 md:mb-16 -mx-5 sm:mx-0"><div class="-mx-5 sm:mx-0"><img src="/assets/blog/issue-comments-github/cover.png" alt="Cover Image for Использование issues в GitHub как движок комментариев" class="shadow-small"/></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><a class="flex items-center" href="https://github.com/JustAddAcid"><img src="https://avatars3.githubusercontent.com/u/21103635?s=120&amp;v=4" class="w-12 h-12 rounded-full mr-4" alt="Roman A. Nosov"/><div class="text-xl font-bold">Roman A. Nosov</div></a></div><div class="mb-6 text-lg"><time dateTime="2020-05-04T14:15:07.322Z">May	4, 2020</time></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__1x9gM"><p>Хочу поделиться замечательной идеей: превращения <strong>GitHub issues</strong> в полноценный движок комментариев для статического блога. Достойная легковесная (и бесплатная!) замена <em>disqus</em> и аналогов.
Для начала, маленькая вводная, с чего всё начиналось:</p>
<p>Был скучный выходной день во время карантина и я лениво читал интернеты в поисках удобного движка комментариев для своего блога. Я уже был готов поддаться маркетингу disqus'a, но внезапно наткнулся на интересную статью:</p>
<p>(<a href="http://donw.io/post/github-comments/">http://donw.io/post/github-comments/</a>)</p>
<p>В ней автор анализирует трафик своего сайта и приходит к удручающему выводу: <em>disqus</em> настолько активно использует трекеры и прочие запросы на сервер, что в примере автора, увеличивал количество XHR-запросов с 16 до 105! Это совершенно неприемлемо. И в качестве альтернативы, рассказчик предлагает переход к ... GitHub Issues! </p>
<p>В статье прелагается следующая схема:</p>
<ol>
<li>На каждый пост в блоге открывается <em>issue в GitHub</em></li>
<li>Все комментарии создаются непосредственно на сайте <em>GitHub</em></li>
<li>При открытии страницы, клиентский JavaScript код получает все комментарии из issue через <em>issue API</em></li>
</ol>
<h2>Заводим свой <del>трактор</del> велосипед</h2>
<p><img src="../assets/blog/issue-comments-github/%D0%BD%D0%BE_%D0%B7%D0%B0%D1%87%D0%B5%D0%BC.png" alt="Возможно всё, но зачем?"></p>
<p>И тут я подумал, что раз уж весь мой блог использует <em>GitHub Pages</em> в качестве хостинга, то почему бы не попробовать ещё больше интегрироваться в экосистему гитхаба?</p>
<h3>Предварительный алгоритм работы с комментариями (пока я не автоматизировал деплой):</h3>
<ol>
<li>Перед созданием поста, руками создаётся issue, оттуда копируется ID и вставляется в .md-темплейт поста.</li>
<li>В исходники страницы добавлен маленький скрипт, который подхватывает этот id страницы и по нему (через Github API получает все комментарии (отрендеренный markdown в html)</li>
<li>Рендер комментариев. </li>
<li>Добавление кнопки "создать комментарий", который просто перебрасывает пользователя на страницу GitHub</li>
</ol>
<h3>Реализация</h3>
<p>Поскольку я храню все посты на этом сайте в markdown файлах, мне первым делом нужно запомнить, что при создании файла, в метаданных я теперь буду обязан указывать issue id.</p>
<pre><code>{
    title: 'Первый пост с использованием markdown и next js'
    excerpt: 'А заодно и проверка возможности писать на кириллице в этом шаблонизаторе. Если вы читаете этот текст, значит полет нормальный.'
    coverImage: '/assets/blog/hello-world/завтра_будет_лучше.jpg'
    date: '2020-05-03T21:00:07.322Z'
    issueId: '1' // &#x3C;--- id созданного issue на GitHub
} 
</code></pre>
<p>В конец страницы с постом добавлен React-компонент Comments, который будет отображать комментарии из ГитХаба. </p>
<pre><code>    &#x3C;article>
        &#x3C;Comments 
            githubUser="JustAddAcid"
            githubRepo="JustAddAcid.github.io"
            issueId={post.issueId} />
    &#x3C;/article>
</code></pre>
<p>Внутри компонента <strong>Comments</strong> делаем GET-запрос в <a href="https://api.github.com/repos/">https://api.github.com/repos/</a> ${githubUser}/ ${githubRepo}/issues/ ${issueId}/comments. Например, для комментариев к этой странице, это будет:</p>
<p>(<a href="https://api.github.com/repos/">https://api.github.com/repos/</a> JustAddAcid/JustAddAcid.github.io/ issues/2/comments)</p>
<pre><code>componentDidMount() {
    if (!this.state.data) {
        const githubUser = this.props.githubUser
        const githubRepo = this.props.githubRepo
        const issueId = this.props.issueId

        const that = this;
        window.fetch(`https://api.github.com/repos/${githubUser}/${githubRepo}/issues/${issueId}/comments`, {
            headers: {
                Accept: 'application/vnd.github.v3.html+json'
            }
        })
            .then(response => response.json())
            .then(comments => that.setState({
                data: comments,
                isLoading: false
            }))
</code></pre>
<p>Ну и красиво рендерим JSON-array, который нам пришел из гитхаба</p>
<pre><code>    render(){
        // ....
        {hasData &#x26;&#x26; (
            this.state.data.map(comment => (
                &#x3C;Comment
                    key={comment.id}
                    avatarUrl={comment.user.avatar_url}
                    userProfileUrl={comment.user.html_url}
                    userLogin={comment.user.login}
                    commentDate={comment.created_at}
                    commentBody={comment.body_html} />
            ))
        )}
        &#x3C;LinkButton text="Добавить комментарий" link={`https://github.com/${githubUser}/${githubRepo}/issues/${issueId}`} />
    }
</code></pre>
<p>После причесывания стилей — получаем достаточно минималистичную и приятную на глаз систему комментариев с поддержкой markdown, цитирования и т.д., которой можно воспользоваться внизу страницы.</p>
<p>Ещё увидимся.</p>
<p><a href="/tags/%D1%82%D0%B0%D0%BD%D1%86%D1%8B_%D1%81_%D0%B1%D1%83%D0%B1%D0%BD%D0%BE%D0%BC">#танцы<em>с</em>бубном</a> <a href="/tags/javascript">#javascript</a> </p>
</div></div></article><article class="mb-32 max-w-2xl mx-auto"><hr class="mb-5"/><h2 class="text-2xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-center">Комментарии</h2><div class="md:flex p-6">Loading...</div><a href="https://github.com/JustAddAcid/JustAddAcid.github.io/issues/2" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-400 rounded shadow mt-2 inline-block">Добавить комментарий</a></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Использование issues в GitHub как движок комментариев","date":"2020-05-04T14:15:07.322Z","slug":"issue-comments-github","author":{"name":"Roman A. Nosov","picture":"https://avatars3.githubusercontent.com/u/21103635?s=120\u0026v=4","url":"https://github.com/JustAddAcid"},"content":"\u003cp\u003eХочу поделиться замечательной идеей: превращения \u003cstrong\u003eGitHub issues\u003c/strong\u003e в полноценный движок комментариев для статического блога. Достойная легковесная (и бесплатная!) замена \u003cem\u003edisqus\u003c/em\u003e и аналогов.\nДля начала, маленькая вводная, с чего всё начиналось:\u003c/p\u003e\n\u003cp\u003eБыл скучный выходной день во время карантина и я лениво читал интернеты в поисках удобного движка комментариев для своего блога. Я уже был готов поддаться маркетингу disqus'a, но внезапно наткнулся на интересную статью:\u003c/p\u003e\n\u003cp\u003e(\u003ca href=\"http://donw.io/post/github-comments/\"\u003ehttp://donw.io/post/github-comments/\u003c/a\u003e)\u003c/p\u003e\n\u003cp\u003eВ ней автор анализирует трафик своего сайта и приходит к удручающему выводу: \u003cem\u003edisqus\u003c/em\u003e настолько активно использует трекеры и прочие запросы на сервер, что в примере автора, увеличивал количество XHR-запросов с 16 до 105! Это совершенно неприемлемо. И в качестве альтернативы, рассказчик предлагает переход к ... GitHub Issues! \u003c/p\u003e\n\u003cp\u003eВ статье прелагается следующая схема:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eНа каждый пост в блоге открывается \u003cem\u003eissue в GitHub\u003c/em\u003e\u003c/li\u003e\n\u003cli\u003eВсе комментарии создаются непосредственно на сайте \u003cem\u003eGitHub\u003c/em\u003e\u003c/li\u003e\n\u003cli\u003eПри открытии страницы, клиентский JavaScript код получает все комментарии из issue через \u003cem\u003eissue API\u003c/em\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eЗаводим свой \u003cdel\u003eтрактор\u003c/del\u003e велосипед\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"../assets/blog/issue-comments-github/%D0%BD%D0%BE_%D0%B7%D0%B0%D1%87%D0%B5%D0%BC.png\" alt=\"Возможно всё, но зачем?\"\u003e\u003c/p\u003e\n\u003cp\u003eИ тут я подумал, что раз уж весь мой блог использует \u003cem\u003eGitHub Pages\u003c/em\u003e в качестве хостинга, то почему бы не попробовать ещё больше интегрироваться в экосистему гитхаба?\u003c/p\u003e\n\u003ch3\u003eПредварительный алгоритм работы с комментариями (пока я не автоматизировал деплой):\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eПеред созданием поста, руками создаётся issue, оттуда копируется ID и вставляется в .md-темплейт поста.\u003c/li\u003e\n\u003cli\u003eВ исходники страницы добавлен маленький скрипт, который подхватывает этот id страницы и по нему (через Github API получает все комментарии (отрендеренный markdown в html)\u003c/li\u003e\n\u003cli\u003eРендер комментариев. \u003c/li\u003e\n\u003cli\u003eДобавление кнопки \"создать комментарий\", который просто перебрасывает пользователя на страницу GitHub\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eРеализация\u003c/h3\u003e\n\u003cp\u003eПоскольку я храню все посты на этом сайте в markdown файлах, мне первым делом нужно запомнить, что при создании файла, в метаданных я теперь буду обязан указывать issue id.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e{\n    title: 'Первый пост с использованием markdown и next js'\n    excerpt: 'А заодно и проверка возможности писать на кириллице в этом шаблонизаторе. Если вы читаете этот текст, значит полет нормальный.'\n    coverImage: '/assets/blog/hello-world/завтра_будет_лучше.jpg'\n    date: '2020-05-03T21:00:07.322Z'\n    issueId: '1' // \u0026#x3C;--- id созданного issue на GitHub\n} \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eВ конец страницы с постом добавлен React-компонент Comments, который будет отображать комментарии из ГитХаба. \u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e    \u0026#x3C;article\u003e\n        \u0026#x3C;Comments \n            githubUser=\"JustAddAcid\"\n            githubRepo=\"JustAddAcid.github.io\"\n            issueId={post.issueId} /\u003e\n    \u0026#x3C;/article\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eВнутри компонента \u003cstrong\u003eComments\u003c/strong\u003e делаем GET-запрос в \u003ca href=\"https://api.github.com/repos/\"\u003ehttps://api.github.com/repos/\u003c/a\u003e ${githubUser}/ ${githubRepo}/issues/ ${issueId}/comments. Например, для комментариев к этой странице, это будет:\u003c/p\u003e\n\u003cp\u003e(\u003ca href=\"https://api.github.com/repos/\"\u003ehttps://api.github.com/repos/\u003c/a\u003e JustAddAcid/JustAddAcid.github.io/ issues/2/comments)\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ecomponentDidMount() {\n    if (!this.state.data) {\n        const githubUser = this.props.githubUser\n        const githubRepo = this.props.githubRepo\n        const issueId = this.props.issueId\n\n        const that = this;\n        window.fetch(`https://api.github.com/repos/${githubUser}/${githubRepo}/issues/${issueId}/comments`, {\n            headers: {\n                Accept: 'application/vnd.github.v3.html+json'\n            }\n        })\n            .then(response =\u003e response.json())\n            .then(comments =\u003e that.setState({\n                data: comments,\n                isLoading: false\n            }))\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eНу и красиво рендерим JSON-array, который нам пришел из гитхаба\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e    render(){\n        // ....\n        {hasData \u0026#x26;\u0026#x26; (\n            this.state.data.map(comment =\u003e (\n                \u0026#x3C;Comment\n                    key={comment.id}\n                    avatarUrl={comment.user.avatar_url}\n                    userProfileUrl={comment.user.html_url}\n                    userLogin={comment.user.login}\n                    commentDate={comment.created_at}\n                    commentBody={comment.body_html} /\u003e\n            ))\n        )}\n        \u0026#x3C;LinkButton text=\"Добавить комментарий\" link={`https://github.com/${githubUser}/${githubRepo}/issues/${issueId}`} /\u003e\n    }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eПосле причесывания стилей — получаем достаточно минималистичную и приятную на глаз систему комментариев с поддержкой markdown, цитирования и т.д., которой можно воспользоваться внизу страницы.\u003c/p\u003e\n\u003cp\u003eЕщё увидимся.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"/tags/%D1%82%D0%B0%D0%BD%D1%86%D1%8B_%D1%81_%D0%B1%D1%83%D0%B1%D0%BD%D0%BE%D0%BC\"\u003e#танцы\u003cem\u003eс\u003c/em\u003eбубном\u003c/a\u003e \u003ca href=\"/tags/javascript\"\u003e#javascript\u003c/a\u003e \u003c/p\u003e\n","ogImage":{"url":"/assets/blog/issue-comments-github/cover.png"},"coverImage":"/assets/blog/issue-comments-github/cover.png","issueId":"2"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"issue-comments-github"},"buildId":"PBFFKh2g75JrK73wwU0ie","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>