{"pageProps":{"post":{"title":"Экспортируем нужные нам данные из openStreetMap","date":"2020-07-05T14:15:07.322Z","slug":"exporting_data_form_osm","author":{"name":"Roman A. Nosov","picture":"https://avatars3.githubusercontent.com/u/21103635?s=120&v=4","url":"https://github.com/JustAddAcid"},"content":"<p>Иногда возникает ситуация, в которой нам жизненно необходимо получить структурированные геоданные для своих проектов. Но где их искать? Делать на коленке парсер <em>google maps</em>?</p>\n<p>На самом деле нет — всё куда прозаичнее. Их можно без зазрения совести скоммуниздить из прекрасного проекта <em>openStreetMaps</em>, попутно дополнив и исправив текущие данные в их базах.</p>\n<p><strong>Краткая справка для тех, кто в танке:</strong> <em>openStreetMaps</em> (или кратко <em>OSM</em>) — <em>open source</em> картографический проект, где каждый пользователь может чуть-чуть дорисовать карту. И по принципу \"с миру по нитке\" собирается свободная и бесплатная карта мира. (как с википедией, только карта)</p>\n<h2>Процесс раскулачивания геосервиса запущен</h2>\n<p><img src=\"../assets/blog/exporting_data_form_osm/meme.jpg\" alt=\"Псс, парень, не хочешь немного геоданных?\"></p>\n<p>Итак, в моём конкретном случае, мне нужно получить данные <strong>по всем железнодорожным станциям России</strong>: название, её код в какой-нибудь международной классификации + координаты. У вас это могут любые другие данные, принцип получения от этого толком не изменяется. </p>\n<p>Для вытаскивания небольших данных из <em>OSM</em> есть онлайновый инструмент, который позволяет делать запросы и получать результат в <em>JSON</em>.</p>\n<p>Но лично для меня этот язык запросов выглядит слишком странным + этот инструмент работает до невозможности медленно (а иногда благополучно лежит). <a href=\"https://overpass-turbo.eu/\">overpass-turbo</a></p>\n<p>Но можно пойти куда <strong>более простым и понятным</strong> путём:</p>\n<ol>\n<li>Скачать дамп всех данных <em>OSM</em> (или маленький кусочек нужной нам территории)</li>\n<li>Отфильтровать объекты (оставить только те типы объектов, которые нам нужны)</li>\n<li>Преобразовать в формат, который пригоден для загрузки в БД</li>\n</ol>\n<h2>Небольшая вставка теории:</h2>\n<p>Чтобы придумать, как вытащить железнодорожные станции, нужно понимать, какие данные и с какой структурой там в принципе есть. </p>\n<p>Есть очень хорошая <a href=\"https://habr.com/ru/post/146503/\">вводная статья на хабре</a>.<br>\nА также имеется <a href=\"https://wiki.openstreetmap.org/wiki/Map_Features\">официальная дока</a>.</p>\n<p><strong>Если кратко:</strong></p>\n<p>Дамп данных из <em>OpenStreetMap</em> можно представить в виде здоровенного XML файла, который содержит в себе <del>помойку</del> большое скопление тэгов трёх типов:</p>\n<ol>\n<li>Точки (<strong>node</strong>)</li>\n<li>Линии (<strong>way</strong>)</li>\n<li>Отношения (<strong>relation</strong>)</li>\n</ol>\n<p>Внутри этих тэгов заполняется всякая информация о них в виде <strong>key:value</strong>.</p>\n<p><strong>Например:</strong>\nДавайте попробуем найти в интерфейсе <em>OSM</em> любую станцию и посмотреть, что там внутри.</p>\n<p>Станция <strong>Шушары</strong> и её информация (слева в таблице):</p>\n<p><img src=\"../assets/blog/exporting_data_form_osm/shushary.png\" alt=\"Станция Шушары в интерфейсе\"></p>\n<p>Теперь посмотрим, как она выглядит в данных:</p>\n<pre><code class=\"language-xml\">&#x3C;node id=\"1377619868\" lat=\"59.8057985\" lon=\"30.3884693\" version=\"9\" timestamp=\"2019-05-08T05:34:15Z\" changeset=\"70007449\" uid=\"474169\" user=\"Yevgeny Gromov\">\n    &#x3C;tag k=\"esr:user\" v=\"033004\"/>\n    &#x3C;tag k=\"name\" v=\"Шушары\"/>\n    &#x3C;tag k=\"railway\" v=\"station\"/>\n    &#x3C;tag k=\"uic_ref\" v=\"2005166\"/>\n    &#x3C;tag k=\"wikidata\" v=\"Q4528146\"/>\n    &#x3C;tag k=\"wikipedia\" v=\"ru:Шушары (станция)\"/>\n&#x3C;/node>\n</code></pre>\n<p>Данные хранятся в виде</p>\n<pre><code class=\"language-xml\">&#x3C;tag k=\"key\" v=\"value\"> \n</code></pre>\n<p>внутри нашей точки <em>\"Шушары\"</em>. А координаты хранятся в атрибутах самого тега \"node\" (lat/lon).</p>\n<p>Замечаем, что признак \"железнодорожная станция\" — это вот такой тэг. На него и будем ориентироваться, когда будем фильтровать данные:</p>\n<pre><code class=\"language-xml\">&#x3C;tag k=\"railway\" v=\"station\"/>\n</code></pre>\n<p>Окей, мы поняли структуру, поняли что нам надо. Но где данные, Лебовски?</p>\n<p><img src=\"../assets/blog/exporting_data_form_osm/meme%20data.jpg\" alt=\"Ваши данные будут храниться здесь\"></p>\n<h2>Добываем данные</h2>\n<p>Если у вас достаточно свободного пространства на жестком диске — можете попробовать выкачать весь мир <a href=\"https://wiki.openstreetmap.org/wiki/Downloading_data\">по официальным инструкциям</a>.</p>\n<p>Либо можно зайти на сайт <a href=\"https://www.openstreetmap.org/\">openStreetMap</a>, открыть на карте нужный квадрат и нажать на \"Экспорт\".</p>\n<h3>У России другой путь</h3>\n<p><strong>Проблема России в том</strong>, что она достаточно большая, чтобы экспорт в интерфейсе <em>openStreetMap</em> <strong>падал</strong> из-за слишком большого количества данных, но всё ещё достаточно маленькая, чтобы ради неё выкачивать весь мир!</p>\n<p>Специально для таких извращенцев, как мы, некоторые люди подготавливают \"нарезку\" мира на удобоваримые куски:</p>\n<ul>\n<li>На <a href=\"https://download.geofabrik.de/\">geofabrik.de</a> имеются нарезки по континентам</li>\n<li>На <a href=\"https://needgeo.com/\">needgeo.com</a> есть данные по странам пост-советского пространства.</li>\n</ul>\n<p>Последняя ссылка как раз нам очень пригодится! :) Выкачиваем оттуда файл RU.pbf (который весит сущие копейки — всего <strong>3GB</strong>)</p>\n<h2>Обрабатываем данные</h2>\n<p>Для обработки нам понадобятся две консольные утилиты: <strong>osmconvert</strong> и <strong>osmfilter</strong>.</p>\n<p>В <em>debian/ubuntu</em> устанавливаются очень просто одной командой:</p>\n<pre><code class=\"language-bash\">sudo apt install osmctools\n</code></pre>\n<p>Для остальных <em>ОС</em> имеются ссылки на бинарники на официальной wiki <a href=\"https://wiki.openstreetmap.org/wiki/Osmfilter\">Osmfilter</a> <a href=\"https://wiki.openstreetmap.org/wiki/Osmconvert\">Osmconvert</a>.</p>\n<p>Во-первых, нам нужно распаковать скачанный файл <strong>.pbf</strong> в пригодный для фильтрации формат.</p>\n<pre><code class=\"language-bash\">osmconvert RU.pbf -o=RU.o5m\n</code></pre>\n<p>На выходе получим файл RU.o5m, который занимает уже 6.2GB. (но это всё ещё бинарный не человеко-читаемый файл.)</p>\n<p>Теперь отбрасываем всё лишнее, оставляя только точки с нужным там тегом (который мы нашли в предыдущих параграфах):</p>\n<pre><code class=\"language-bash\">osmfilter RU.o5m --keep=\"railway=station\" > stations.osm\n</code></pre>\n<p>Компьютер задумается на какое-то время, а затем заполнит файл <em>stations.osm</em>. Де-факто, уже почти всё. Мы на выходе получили <em>XML</em> файл со всеми нужными нам станциями (3Mb). </p>\n<p><strong>Попробуем проверить данные:</strong>\nОткрываем в любом текстовом редакторе, который способен открывать большие текстовые файлы (vim), и бегло просматриваем станции:</p>\n<p>И тут натыкаемся на станцию метро \"Озерки\". Что ж, формально — это жд, и формально — станция. Но не совсем то, что мне нужно. :)</p>\n<pre><code class=\"language-xml\">&#x3C;node id=\"96459081\" lat=\"60.0354511\" lon=\"30.3210663\" version=\"24\" timestamp=\"2020-01-08T22:53:32Z\" changeset=\"79358758\" uid=\"217225\" user=\"&#x26;#38;ergio\">\n    &#x3C;tag k=\"colour\" v=\"blue\"/>\n    &#x3C;tag k=\"layer\" v=\"-5\"/>\n    &#x3C;tag k=\"name\" v=\"Озерки\"/>\n    &#x3C;tag k=\"name:de\" v=\"Oserki\"/>\n    &#x3C;tag k=\"name:en\" v=\"Ozerki\"/>\n    &#x3C;tag k=\"name:fi\" v=\"Ozerki\"/>\n    &#x3C;tag k=\"name:ru\" v=\"Озерки\"/>\n    &#x3C;tag k=\"network\" v=\"Петербургский метрополитен\"/>\n    &#x3C;tag k=\"operator\" v=\"Петербургский метрополитен\"/>\n    &#x3C;tag k=\"public_transport\" v=\"station\"/>\n    &#x3C;tag k=\"railway\" v=\"station\"/>\n    &#x3C;tag k=\"station\" v=\"subway\"/>\n    &#x3C;tag k=\"subway\" v=\"yes\"/>\n    &#x3C;tag k=\"transport\" v=\"subway\"/>\n    &#x3C;tag k=\"wikidata\" v=\"Q2241386\"/>\n    &#x3C;tag k=\"wikipedia\" v=\"ru:Озерки (станция метро)\"/>\n&#x3C;/node>\n</code></pre>\n<p>Видим там целых три тега, которые свидетельствуют о том, что это метро. (зачем такая избыточность?)</p>\n<pre><code class=\"language-xml\">&#x3C;tag k=\"station\" v=\"subway\"/>\n&#x3C;tag k=\"subway\" v=\"yes\"/>\n&#x3C;tag k=\"transport\" v=\"subway\"/>\n</code></pre>\n<p>Фильтруем по этим тегам:</p>\n<pre><code class=\"language-bash\">osmfilter stations.osm --drop=\"station=subway or subway=yes or transport=subway\" > not_subway.osm\n</code></pre>\n<p>Смотрим на выходной файл — выглядит так, словно успешно отфильтровали. Теперь осталось превратить xml файл в CSV, чтобы удобно залить в базу.</p>\n<p>Смотрим на документацию по станциям и составляем список тегов, которые будем выводить в CSV:\n<a href=\"https://wiki.openstreetmap.org/wiki/RU:Tag:railway%3Dstation\">railway:stations</a></p>\n<p><strong>Нужные нам столбцы:</strong> </p>\n<ol>\n<li>id</li>\n<li>lat</li>\n<li>lon</li>\n<li>name</li>\n<li>uic_ref — уникальный код железнодорожной станции, присваиваемый UIC (International Union of Railways, Международный союз железных дорог).</li>\n<li>esr:user — уникальный код железнодорожной станции в Единой сетевой разметке (ЕСР, для станций Балтики и стран СНГ).</li>\n</ol>\n<p>Экспортируем (обратите внимание, что атрибуты самого <em>node</em> записываются через \"@\"):</p>\n<pre><code class=\"language-bash\">osmconvert not_subway.osm --all-to-nodes --csv=\"@id @lat @lon name uic_ref esr:user\" --csv=headline > stations.csv\n</code></pre>\n<p>Теперь мы можем со спокойной совестью делать с этими данными, что душе угодно. Можем обрабатывать руками в <em>EXCEL</em>, можем залить в базу и использовать в своих разнообразных проектах. </p>\n<p>Если найдете какие-то неточности в данных, очень рекомендуется исправить их не только у себя, а залить их также на саму <em>OpenStreetMap</em>. Так сказать, сделать свой маленький вклад в общее дело. :)</p>\n<p>P.S. Мистическим образом, под железнодорожные станции ещё мимикрирует Волгоградский метротрам. Но его уже можно отфильтровать в итоговом CSV.</p>\n<iframe frameborder=\"0\" style=\"border:none;width:100%;height:180px;\" width=\"100%\" height=\"180\" src=\"https://music.yandex.ru/iframe/#track/31840941/3867842\">Слушайте <a href='https://music.yandex.ru/album/3867842/track/31840941'>У трамвая жизнь кривая. норвежская свекла</a>  —  <a href='https://music.yandex.ru/artist/3976133'>Ремонт Воды</a> на Яндекс.Музыке</iframe>\n<p><a href=\"../assets/blog/exporting_data_form_osm/stations.csv\">Итоговый CSV файл со станциями здесь.</a></p>\n<p><a href=\"/tags/%D1%82%D0%B0%D0%BD%D1%86%D1%8B_%D1%81_%D0%B1%D1%83%D0%B1%D0%BD%D0%BE%D0%BC\">#танцы<em>с</em>бубном</a> <a href=\"/tags/%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0_%D1%81_%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%BC%D0%B8\">#работа<em>с</em>данными</a></p>\n","ogImage":{"url":"/assets/blog/exporting_data_form_osm/background.jpg"},"coverImage":"/assets/blog/exporting_data_form_osm/background.jpg","issueId":"12"}},"__N_SSG":true}