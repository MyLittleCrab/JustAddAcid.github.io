{"pageProps":{"post":{"title":"Сбор и автоматическая фильтрация вложений диалога VK","titleEnabled":true,"date":"2021-06-19T12:05:26.774Z","slug":"get-all-photos-from-chat-vk","author":{"name":"Roman A. Nosov","picture":"https://avatars3.githubusercontent.com/u/21103635?s=120&v=4","url":"https://github.com/JustAddAcid"},"content":"<p>Удаляться из соцсетей всегда немного жалко. Особенно, когда годами использовал некоторые чаты просто как хостинг фотографий. Так что, мною было принято ответственное решение выкачать все <em>несколько-гигабайт</em> изображений из таких чатов и, естественно, удалить из них мусорные мемы <em>(хотя есть смысл их хранить где-то отдельно)</em></p>\n<p>Т.е. на сегодняшний вечер у нас две подзадачи:</p>\n<ol>\n<li>Выкачать контент</li>\n<li>Разложить контент на две директории: мемы и фото</li>\n</ol>\n<h2>Викачуємо</h2>\n<p>Поиск готовых расширений для браузера/софтин для выкачивания содержимого чатов завершился неудачно. Что ж, придется дёргать целый один(!) метод из VK API, кокой ужос. </p>\n<p>Для моих целей нужен метод <a href=\"https://vk.com/dev/messages.getHistoryAttachments\">messages.getHistoryAttachments</a>. А дёргать я его буду из обертки под node.js — <a href=\"https://github.com/ciricc/easyvk\">easyvk</a>, ибо незачем изобретать велосипеды. Скачивать буду пачками по 50 штук. Несмотря на то, что документация утверждает об умении выгружать вплоть до 200 штук на запрос, но на практике, на запросы больше 50 иногда не хотят отвечать.</p>\n<p>Логинимся, получаем объект vk, через который будем стучаться в API:</p>\n<div class=\"remark-highlight\"><pre class=\"language-JavaScript\"><code class=\"language-JavaScript\">easyvk({\n  username: login,\n  password: password,\n  sessionFile: path.join(__dirname, &#x26;#39;.my-session&#x26;#39;)\n}).then(async vk =&#x26;gt; { /* {...} */ });</code></pre></div>\n<p>Дальше остаётся лишь пробежаться циклом по всем вложениям, постоянно сохраняя id сообщения, на котором остановились:</p>\n<div class=\"remark-highlight\"><pre class=\"language-JavaScript\"><code class=\"language-JavaScript\">const vkr = await vk.call(&#x26;#39;messages.getHistoryAttachments&#x26;#39;, {\n  peer_id: peerId,\n  media_type: &#x26;#39;photo&#x26;#39;,\n  count: 50,\n  start_from: from\n});\n\nconst downloads = vkr.items.map((item, index) =&#x26;gt; {\n  return download(item.attachment.photo.sizes.pop().url, &#x26;#39;./attachments/&#x26;#39;, { \n    filename: + item.attachment.photo.date + index + &#x26;#39;.jpg&#x26;#39; \n  })\n});\n\nawait Promise.allSettled(downloads);\n\nfrom = vkr.items.pop().message_id;</code></pre></div>\n<p>Элементарно. Осталось удалить дубликаты: т.к. если кто-то \"отвечал\" на сообщения с фотографией, она может продублироваться у нас в файлах. Мы можем сравнить фото по их md5 хешу, и удалить, если у каких-то картинок эти хеши совпадают.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">find</span> <span class=\"token builtin class-name\">.</span> -type f <span class=\"token punctuation\">\\</span>\n    <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> md5sum <span class=\"token punctuation\">\\</span>\n    <span class=\"token operator\">|</span> <span class=\"token function\">sort</span> -k1,1 <span class=\"token punctuation\">\\</span>\n    <span class=\"token operator\">|</span> <span class=\"token function\">uniq</span> -Dw32 <span class=\"token punctuation\">\\</span>\n    <span class=\"token operator\">|</span> <span class=\"token keyword\">while</span> <span class=\"token builtin class-name\">read</span> <span class=\"token builtin class-name\">hash</span> <span class=\"token function\">file</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> \n        <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">${prev_hash}</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"<span class=\"token variable\">${hash}</span>\"</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token function\">rm</span> -v <span class=\"token string\">\"<span class=\"token variable\">${file}</span>\"</span>\n        <span class=\"token assign-left variable\">prev_hash</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${hash}</span>\"</span><span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">done</span>\n</code></pre></div>\n<h2>Сортируем изображения</h2>\n<p>Поначалу я думал, что на эту задачу я потрачу гораздо больше времени и сил. Но как оказалось, вся инфраструктура для этого уже давно изобретена и отработана. Достаточно лишь вызвать готовые инструменты. </p>\n<p>Отделять котлеты от мух будем по признаку наличия текста: </p>\n<ul>\n<li>Если на картинке есть текст длиннее 10 символов, то считаем её мемом</li>\n<li>Иначе считаем фотографией </li>\n</ul>\n<p>Для распознавания текста мне понадобится питон, OCR-движок <a href=\"https://github.com/UB-Mannheim/tesseract/wiki\">tesseract</a>, и следующие пакеты, которые можно установить через pip'у.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">pip <span class=\"token function\">install</span> opencv-python\npip <span class=\"token function\">install</span> pytesseract\n</code></pre></div>\n<p>Ну и простейший скрипт, который дёргает api распознавания, удаляет лишние whitespace'ы и проверяет длину строки. </p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> cv2\n<span class=\"token keyword\">import</span> pytesseract\n<span class=\"token keyword\">import</span> re\n<span class=\"token keyword\">import</span> os\n\ninputDir <span class=\"token operator\">=</span> <span class=\"token string\">'...'</span>\nwithoutTextDir <span class=\"token operator\">=</span> <span class=\"token string\">'...'</span>\nwithTextDir <span class=\"token operator\">=</span> <span class=\"token string\">'...'</span>\n\ninputFilenames <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>listdir<span class=\"token punctuation\">(</span>inputDir<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> filename <span class=\"token keyword\">in</span> inputFilenames<span class=\"token punctuation\">:</span>\n    img <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>imread<span class=\"token punctuation\">(</span>inputDir <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">)</span>\n    text <span class=\"token operator\">=</span> pytesseract<span class=\"token punctuation\">.</span>image_to_string<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> lang<span class=\"token operator\">=</span><span class=\"token string\">'rus'</span><span class=\"token punctuation\">)</span>\n    text <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span>sub<span class=\"token punctuation\">(</span><span class=\"token string\">'\\s+'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">10</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Перекладываем в папку, где хранятся картинки с текстом</span>\n        os<span class=\"token punctuation\">.</span>rename<span class=\"token punctuation\">(</span>inputDir <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">,</span> withTextDir <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Перекладываем в папку, где хранятся картинки без текста</span>\n        os<span class=\"token punctuation\">.</span>rename<span class=\"token punctuation\">(</span>inputDir <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">,</span> withoutTextDir <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n\\n'</span><span class=\"token punctuation\">,</span> filename<span class=\"token punctuation\">,</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>Собственно, на этом всё. Есть, конечно небольшие погрешности в работе. Но они решаются беглым просмотром превью картинок. Фотографии выгружены, можно удаляться из вконтакта. </p>\n<p><a href=\"https://gist.github.com/JustAddAcid/79c3a5264880d77d7e069a34f0b33934\">Скрипт скачивания вложений из диалога</a></p>\n<p><a href=\"https://gist.github.com/JustAddAcid/e24ac023f841bb5f93b85085d380a3ac\">Сортировка картинок по наличию текста</a></p>\n","ogImage":{"url":"/assets/blog/get-all-photos-from-chat-vk/background.jpg"},"coverImage":"/assets/blog/get-all-photos-from-chat-vk/background.jpg","issueId":"22"}},"__N_SSG":true}