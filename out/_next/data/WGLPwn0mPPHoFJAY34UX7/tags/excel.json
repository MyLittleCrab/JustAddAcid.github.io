{"pageProps":{"allPosts":[{"title":"Авторесайз объединенных ячеек в EXCEL","date":"2020-09-25T18:08:48.775Z","slug":"autoresize-excel-tables","author":{"name":"Roman A. Nosov","picture":"https://avatars3.githubusercontent.com/u/21103635?s=120&v=4","url":"https://github.com/JustAddAcid"},"content":"\nПрежде чем перейти к сути, давайте на минуточку остановимся и осознаем всю степень сюрреализма, который творится в государственном документообороте. Подумайте над тем, что если вы отправляете государству какую-то распечанную *EXCEL* табличку на бумажке(потому что именно так требует закон), то на принимающей стороне есть **ОТДЕЛЬНЫЙ, МАТЬ ЕГО, ЧЕЛОВЕК**, который руками забивает эти данные куда-то себе в базу!\n\nОсознали? Прекрасно. Продолжаем.\n\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/lN-Y242GOgk\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n\nТак уж исторически сложилось, что часто по работе люди встречаются со \"стандартными\" формами в *EXCEL*, которые нужно автоматически растягивать в зависимости от контента в ячейках. \n\nКазалось бы, достаточно распространённая тема, по которой **уйма** информации в этих ваших интернетах. Но проводить по этому поводу ликбез мне уже приходилось несколько раз за последние пару месяцев. Так что, лучше **записать** это дерьмо, чтобы не повторять одно и то же. И потратить сэкономленное время на ~~прокрастинацию~~ более важные дела.\n\n## Формулируем задачу\n\nПредставим ситуацию, в которой есть какая-то программа, которая на основании данных в *БД* заполняет какой-то *ГОСТ*-овский *EXCEL*-темплейт данными, который в будущем кому-то отправляется и/или распечатывается. И в этой (уже абсурдной) ситуации совершенно никому не хочется тратить собственное время на растягивание ячеек вручную. И очень хочется как-то этот процесс автоматизировать.\n\n## Чо делать?\n\n~~do a barrel roll~~\n\nРесайзить макросом, очевидно. Тут у нас два пути в зависимости от того, насколько над нами хотят поиздеваться окружающие:\n\n### Самый простой вариант\nЭто когда мы видим, что в документе напрочь отсутствуют объединённые ячейки, которые нужно ресайзить. А ресайзинг одиночных — *EXCEL* поддерживает нативно. Достаточно ругнуться на него вот такой командой:\n\n```vb\nCells.EntireRow.AutoFit ' Растянуть ячейки в высоту по контенту\n' Или\nCells.EntireColumn.AutoFit ' Растянуть ячейки в ширину по контенту\n\n' Или, на конкретную ячейку \nОбъектЯчейки.EntireColumn/EntireRow.AutoFit \n```\n\n### Вариант \"как всегда\"\nНо если вы читаете это, то скорее всего, у вас возникли сложности посерьёзнее. Вероятно, у вас самый обычный документ, в котором огромное количество связанных ячеек.\n\n*Що робити в цій ситуації?*\n\nМожно, конечно, попробовать изобрести очередной велосипед. А можно воспользоваться готовым кодом, который честно ~~спиз~~ сохранил из интернетов ваш покорный слуга.\n\nАвтором кода числится некий **The_Prist (Щербаков Дмитрий)** с сайта [excel-vba.ru](https://www.excel-vba.ru). Идея кода в том, что скрипт сначала временно отключает объединение ячеек, ресайзит первую ячейку с текстом нативными методами экселя, а затем объединяет ячейки обратно.\n\nПолучается достаточно просто и лаконично. Я лишь от себя добавил в код небольшой фикс, чтобы учитывались паддинги и масштабирование не \"съезжало\" при большом количестве ячеек.\n\n[Репозиторий с кодом можно найти здесь.](https://github.com/JustAddAcid/Excel_RowHeightForContent)\n\nКак этим пользоваться:\n\n1. Проверить, что у вас тип файла с поддержкой макросов (с \"m\" на конце)\n2. Залезть в *Вид* -> *Макросы* -> *Ввести %randomName%* -> **Создать**\n3. ПКМ по *Modules* -> *Insert* -> **Module**\n4. Скопировать содержимое файла **RowHeightForContent.vb** из [репозитория](https://github.com/JustAddAcid/Excel_RowHeightForContent) в новый созданный модуль\n5. Вызвать **RowColHeightForContent** с нужными ячейками. \n\nНо! Один вызов функции принимает в аргументы рейндж **из одной** связанной ячейки. Нельзя сразу выделить всю страницу и попытаться её отмасштабировать.  \n\nИтоговый код вызова будет примерно вот таким\n\n```vb\n' Две статичные ячейки\nRowColHeightForContent ActiveWorkbook.Sheets(1).Range(\"S32\")\nRowColHeightForContent ActiveWorkbook.Sheets(1).Range(\"AV30\")\n\nDim i As Integer\n\n' Масштабирование строк в таблицах циклом\n' На втором листе\ni = 8\nDo While Len(ActiveWorkbook.Sheets(2).Cells(i, 7).Value) > 0\n    RowColHeightForContent ActiveWorkbook.Sheets(2).Cells(i, 7) ' Седьмой столбец\n    RowColHeightForContent ActiveWorkbook.Sheets(2).Cells(i, 228) ' 228 столбец\n\n    '(или вложенным циклом от N до M столбца)\n    \n    i = i + 1\nLoop\n\n' На третьем листе\ni = 5\nDo While Len(ActiveWorkbook.Sheets(3).Cells(i, 7).Value) > 0\n    RowColHeightForContent ActiveWorkbook.Sheets(3).Cells(i, 7)\n    i = i + 1\nLoop\n```\n\n## Когда делать?\n\nПо какому событию вызывать этот код? У нас не много вариантов: \n\n1. Если происходит заполнение темплейта через EXCEL-OLE API, то можно попробовать подвязаться на событие завершения сборки файла. (Тут нужно смотреть документацию вашего инструмента, который выгружает)\n2. Во всех остальных случаях — можно выполнять код по событию **\"Открытие файла\"** (*Workbook_Open*).\n   1. Для этого, нужно открыть модуль \"Эта книга\": ![Эта книга](../public/assets/blog/autoresize-excel-tables/this_book.png)\n   2. Затем создать функцию **Workbook_Open** примерно вот так:\n\n```vb\nPrivate Sub Workbook_Open()\n\n' Здесь код ресайза\n\nEnd Sub\n```\n\nВ которую положить ~~болт~~ код ресайза нужных вам ячеек в документе. При открытии файла у пользователя будет всплывать запрос на разрешение выполнения макроса. И если он согласится — выбранные программистом ячейки будут растянуты по размеру содержимого. Собсна, всё.\n\n## Послание читателю\n\nВозможно, я недостаточно раскрыл тему. Так что, если у вас остались вопросы — ~~гугл вам в помощь~~ прошу нафлудить в комментариях.\n\nВсех благ\n\n#excel #офисная_боль","ogImage":{"url":"/assets/blog/autoresize-excel-tables/background.jpg"},"coverImage":"/assets/blog/autoresize-excel-tables/background.jpg","issueId":"16","excerpt":"Так уж исторически сложилось, что часто по работе люди встречаются со \"стандартными\" формами в EXCEL, которые нужно автоматически масштабировать в зависимости от контента в ячейках"}],"tag":"excel"},"__N_SSG":true}