<!DOCTYPE html><html lang="ru"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Nosoff.info — personal blog"/><title>Экспорт данных из SAP Query-отчета во внутреннюю таблицу через SPOOL</title><meta property="og:image" content="/assets/blog/export-data-to-sap-spool/background.jpg"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/8989f9f4657d19f0fcdb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8989f9f4657d19f0fcdb.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dab348d518a0e6702e4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dab348d518a0e6702e4.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/framework-92300432a1172ef1338b.js" defer=""></script><script src="/_next/static/chunks/main-a3a79aff3ff232b41814.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f98b93c1570ecf70d9fa.js" defer=""></script><script src="/_next/static/chunks/853-ae4f3fbc7686be6d8798.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-27720eb20c91d7796fb9.js" defer=""></script><script src="/_next/static/WGLPwn0mPPHoFJAY34UX7/_buildManifest.js" defer=""></script><script src="/_next/static/WGLPwn0mPPHoFJAY34UX7/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="min-h-screen"><main><div class="container mx-auto px-5"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8"><a class="hover:underline" href="/">Nosoff.info</a></h2><article class="mb-32"><h1 class="screenreader">Экспорт данных из SAP Query-отчета во внутреннюю таблицу через SPOOL</h1><div class="hidden md:block md:mb-12"><a class="flex items-center" href="https://github.com/JustAddAcid"><img src="https://avatars3.githubusercontent.com/u/21103635?s=120&amp;v=4" class="w-12 h-12 rounded-full mr-4" alt="Roman A. Nosov"/><div class="text-xl font-bold">Roman A. Nosov</div></a></div><div class="mb-8 md:mb-16 -mx-5 sm:mx-0"><div class="-mx-5 sm:mx-0"><img src="/assets/blog/export-data-to-sap-spool/background.jpg" alt="Cover Image for Экспорт данных из SAP Query-отчета во внутреннюю таблицу через SPOOL" class="shadow-small"/></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><a class="flex items-center" href="https://github.com/JustAddAcid"><img src="https://avatars3.githubusercontent.com/u/21103635?s=120&amp;v=4" class="w-12 h-12 rounded-full mr-4" alt="Roman A. Nosov"/><div class="text-xl font-bold">Roman A. Nosov</div></a></div><div class="mb-6 text-lg"><time dateTime="2021-03-20T08:40:14.217Z">March	20, 2021</time></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__1x9gM"><p>Господа, м'сье абапье и прочие любители подглядывать за страданиями! Представляю вашему вниманию очередной результат танцев с бубенцами. Который в этот раз будет чуть менее бесполезным. И (быть может) сэкономит время какому-нибудь заблудившемуся <strong>SAP</strong>-кодерасту.</p>
<p>Иногда хочется выть от боли, когда в очередной раз появляются требования выгрузки данных из стандартных или квази-стандартных отчетов SAP. Которые зачастую вообще не предусматривают какой-либо экспорт или расширение.</p>
<p>Дальше будет <strong>ABAP</strong> и рассказывания о подноготной <strong>SAP ERP</strong>. Если у вас нет вуайеристских наклонностей или профессионального интереса в дальнейшем тексте, то рекомендую закрыть страницу, чтобы не испытать экзистенциальный ужас от полученной информации.</p>
<p>Что ж, погружаемся, товарищи. Так сказать, пристегните ремни. Будет немного трясти <del>и пованивать</del>.</p>
<p><img src="../assets/blog/export-data-to-sap-spool/dipping.jpg" alt="Погружаемся!"></p>
<h2>Поехали.</h2>
<p>Итак, представим ситуацию: Вы сидите, неспешно ковыряете код. И тут прилетает задача —  достать данные из древнего отчета, нарисованного в <strong>SAP Query</strong> через <strong>Report painter</strong>; их немного обработать и отдать в другой интерфейс.</p>
<p>Казалось бы, что может быть сложного? Ну, например, всё. </p>
<h3>SAP Query (далее SQ)</h3>
<p>Это сраный <strong>SAP Query</strong>. Пользователь мышой натыкивает нужные ему поля и форму отчета, а на выходе получает готовый отчет. Софтина сама собирает ABAP-программу по конфигу. Класна? Нет. </p>
<p>Каждая дальнейшая правка отчета в пользовательской морде пересобирает целиком <em>всё</em>. Более того, никто не гарантирует, что программа пересоберется с тем же техническим названием. Ну и при переезде правок по ландшафту дев-тест-прод -> будет генерироваться разное название.</p>
<p><strong>Вывод:</strong> Вписаться в код отчета и вытащить данные перед их отображением —  не получится. Юзверь перезатрёт всё прямзавтра. А скорее всего —  вчера.</p>
<p><img src="../assets/blog/export-data-to-sap-spool/userflow.jpg" alt="userflow"></p>
<h3>Report Painter</h3>
<p>Я нарвался на <em>"не совсем классическое"</em>  использование <strong>SQ</strong>! Данные выводятся не напрямую, а проходят через <em>"прослойку отрисовщика"</em> (Report Painter). И воспользоваться стандартным FM <strong>RSAQ_REMOTE_QUERY_CALL</strong>, увы, не выйдет. </p>
<p>Т.к. для заданного отчета вообще нет таких параметров, как <em>"имя запроса"</em> и  <em>"группа пользователей"</em>. Просто н<strong>е</strong>чего подавать в аргументы функции.</p>
<p><strong>Вывод:</strong> Увы, воспользоваться предусмотренными FM невозможно. </p>
<h3>Это, мать вашу, не ALV</h3>
<p>А жаль. При отображении, ALV-таблицы постят свои мета-(и не очень мета)данные в глобальный скоуп сессии пользователя. И оттуда элементарно вытащить что угодно. Например, вот так:</p>
<div class="remark-highlight"><pre class="language-abap"><code class="language-abap">cl_salv_bs_runtime_info<span class="token token-operator punctuation">=></span>set<span class="token punctuation">(</span> <span class="token keyword">EXPORTING</span> <span class="token keyword">display</span>  <span class="token operator">=</span> abap_false  
										metadata <span class="token operator">=</span> abap_true  
										<span class="token keyword">data</span>     <span class="token operator">=</span> abap_true <span class="token punctuation">)</span><span class="token punctuation">.</span>
										
<span class="token eol-comment comment">" submit report and return</span>

cl_salv_bs_runtime_info<span class="token token-operator punctuation">=></span>get_data_ref<span class="token punctuation">(</span> <span class="token keyword">IMPORTING</span> r_data <span class="token operator">=</span> ro_data <span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token eol-comment comment">" do with ro_data what you want</span>
</code></pre></div>
<h3>Не работает ... exporting list to memory</h3>
<p>Необъяснимо, но факт. Несмотря на то, что SQ-отчеты де-факто рендерят стандартный лист!</p>
<p>Попытка экспортировать таким способом просто подвешивает основной поток выполнения и ничего не делает. Чому? Об этом знает только аллах. </p>
<div class="remark-highlight"><pre class="language-abap"><code class="language-abap"><span class="token keyword">submit</span> prog <span class="token keyword">and</span> <span class="token keyword">return</span> <span class="token keyword">exporting</span> <span class="token keyword">list</span> <span class="token keyword">to</span> <span class="token keyword">memory</span><span class="token punctuation">.</span> <span class="token eol-comment comment">" not working</span>
</code></pre></div>
<h3>Но выход всегда есть</h3>
<p><em>(особенно, если вы живёте достаточно высоко)</em></p>
<p>Давайте подумаем, <strong>что может быть общего</strong> между матричными принтерами, и решением моей задачи? </p>
<p><img src="../assets/blog/export-data-to-sap-spool/printer.jpeg" alt="printer"></p>
<p>Да, теми самыми принтерами с рулоном ленты. Которые буквально печатают "стуча" по бумаге, как старые печатающие машинки. И которые могут использовать только <em>ASCII</em> символы. </p>
<p><strong>А то</strong>, что <strong>SAP</strong> <em>(Эдакая древняя громадина)</em> из коробки поддерживает <em>ASCII</em>-фикацию и печать всех отчетов, которые отрисовываются "стандартным" способом. Так это же то, что мне нужно! Такой текст будет элементарно распарсить после получения.</p>
<p>Достаточно дёрнуть печать отчета, и вовремя подхватить <em>ASCII</em>-фицированный документ кодом! Получается что-то вроде этого:</p>
<p>Создаём фоновое задание, где будет выполняться рендеринг и попытка печати.</p>
<div class="remark-highlight"><pre class="language-abap"><code class="language-abap"><span class="token keyword">CALL</span> <span class="token keyword">FUNCTION</span> <span class="token string">'JOB_OPEN'</span>
  <span class="token keyword">EXPORTING</span>
    jobname          <span class="token operator">=</span> kv_job_name
  <span class="token keyword">IMPORTING</span>
    jobcount         <span class="token operator">=</span> lv_jobcount<span class="token punctuation">.</span>
</code></pre></div>
<p>Собираем параметры печати. Нам нужно попросить программу напечататься сразу же после выполнения, и не показывать никаких диалогов. </p>
<div class="remark-highlight"><pre class="language-abap"><code class="language-abap"><span class="token keyword">CALL</span> <span class="token keyword">FUNCTION</span> <span class="token string">'GET_PRINT_PARAMETERS'</span>
  <span class="token keyword">EXPORTING</span>
    list_name      <span class="token operator">=</span> <span class="token string">'TEST'</span>
    list_text      <span class="token operator">=</span> <span class="token string">'SUBMIT this fucking program TO SAP-SPOOL'</span>
    <span class="token keyword">immediately</span>    <span class="token operator">=</span> abap_true
    no_dialog      <span class="token operator">=</span> abap_true
  <span class="token keyword">IMPORTING</span>
    out_parameters <span class="token operator">=</span> ls_params
    <span class="token keyword">valid</span>          <span class="token operator">=</span> lv_valid<span class="token punctuation">.</span>
</code></pre></div>
<p>Вызываем программу в фоне со всеми собранными параметрами. Конструкция <strong>to sap-spool ... without spool</strong> нисколько сап не смущает. И вполне корректно отрабатывает. </p>
<div class="remark-highlight"><pre class="language-abap"><code class="language-abap"><span class="token keyword">SUBMIT</span> program_technical_name <span class="token keyword">USING</span> <span class="token keyword">SELECTION-SET</span> <span class="token string">'VAR1'</span> 
      <span class="token keyword">TO</span> <span class="token keyword">SAP-SPOOL</span> <span class="token keyword">SPOOL</span> <span class="token keyword">PARAMETERS</span> ls_params 
      <span class="token keyword">WITHOUT</span> <span class="token keyword">SPOOL</span> <span class="token keyword">DYNPRO</span> 
      <span class="token keyword">VIA</span> <span class="token keyword">JOB</span> kv_job_name <span class="token keyword">NUMBER</span> lv_jobcount 
      <span class="token keyword">AND</span> <span class="token keyword">RETURN</span><span class="token punctuation">.</span>
</code></pre></div>
<p>Так, программу мы вызвали, теперь придется костылём дожидаться завершения фоновой задачи. Никаких ивентов и коллбэков тут нет. </p>
<div class="remark-highlight"><pre class="language-abap"><code class="language-abap"><span class="token eol-comment comment">" Костыль ожидания завершения асинхронной жобы</span>
<span class="token keyword">WHILE</span> ls_empty <span class="token keyword">IS</span> <span class="token keyword">INITIAL</span><span class="token punctuation">.</span>
  <span class="token keyword">WAIT</span> <span class="token keyword">UP</span> <span class="token keyword">TO</span> <span class="token number">5</span> <span class="token keyword">SECONDS</span><span class="token punctuation">.</span>
  <span class="token keyword">SELECT</span> <span class="token keyword">SINGLE</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tbtco <span class="token keyword">INTO</span> ls_empty <span class="token keyword">WHERE</span> jobname <span class="token operator">=</span> kv_job_name <span class="token keyword">AND</span> jobcount <span class="token operator">=</span> lv_jobcount <span class="token keyword">AND</span> status <span class="token operator">=</span> <span class="token string">'F'</span><span class="token punctuation">.</span>
<span class="token keyword">ENDWHILE</span><span class="token punctuation">.</span>
</code></pre></div>
<p>Ну, собственно, всё. Фоновая задача завершена. В системе уже хранятся отрендеренные данные, и нам остаётся лишь их подхватить. </p>
<div class="remark-highlight"><pre class="language-abap"><code class="language-abap"><span class="token keyword">SELECT</span> <span class="token keyword">SINGLE</span> listident
  <span class="token keyword">FROM</span> tbtcp
  <span class="token keyword">INTO</span> lv_listident
  <span class="token keyword">WHERE</span> jobname <span class="token operator">=</span> kv_job_name
    <span class="token keyword">AND</span> jobcount <span class="token operator">=</span> lv_jobcount<span class="token punctuation">.</span>
 
<span class="token keyword">CHECK</span> lv_listident <span class="token keyword">IS</span> <span class="token keyword">NOT</span> <span class="token keyword">INITIAL</span><span class="token punctuation">.</span>
 
lv_rqident <span class="token operator">=</span> lv_listident<span class="token punctuation">.</span>
 
<span class="token keyword">CALL</span> <span class="token keyword">FUNCTION</span> <span class="token string">'RSPO_RETURN_ABAP_SPOOLJOB'</span>
  <span class="token keyword">EXPORTING</span>
    rqident              <span class="token operator">=</span> lv_rqident
  <span class="token keyword">TABLES</span>
    <span class="token keyword">buffer</span>               <span class="token operator">=</span> lt_buffer<span class="token punctuation">.</span>
</code></pre></div>
<p>В результате получаем внутрённюю таблицу <strong>lt_buffer</strong> из строк отчета. Её элементарно разбирать на куски, и вытаскивать нужные нам значения.</p>
<p>Столбцы в такой таблице разделены символом вертикальной черты '|' и ничего не стоит распарсить поля по отдельности. </p>
<p><a href="https://gist.github.com/JustAddAcid/450d4cd5f1069dbac61c3e842508b969">Полный код на github gists здесь</a></p>
<iframe frameborder="0" style="border:none;width:100%;height:180px;" width="100%" height="180" src="https://music.yandex.ru/iframe/#track/57987781/8763763">Слушайте <a href='https://music.yandex.ru/album/8763763/track/57987781'>What the Fuck</a> — <a href='https://music.yandex.ru/artist/7756103'>RHODAMINE</a> на Яндекс.Музыке</iframe>
<p><a href="/tags/abap">#abap</a> <a href="/tags/%D1%82%D0%B0%D0%BD%D1%86%D1%8B_%D1%81_%D0%B1%D1%83%D0%B1%D0%BD%D0%BE%D0%BC">#танцы<em>с</em>бубном</a></p>
</div></div></article><article class="mb-32 max-w-2xl mx-auto"><hr class="mb-5"/><h2 class="text-2xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-center">Комментарии</h2><div class="md:flex p-6">Loading...</div><a href="https://github.com/JustAddAcid/JustAddAcid.github.io/issues/18" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-400 rounded shadow mt-2 inline-block">Добавить комментарий</a></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Экспорт данных из SAP Query-отчета во внутреннюю таблицу через SPOOL","date":"2021-03-20T08:40:14.217Z","slug":"export-data-to-sap-spool","author":{"name":"Roman A. Nosov","picture":"https://avatars3.githubusercontent.com/u/21103635?s=120\u0026v=4","url":"https://github.com/JustAddAcid"},"content":"\u003cp\u003eГоспода, м'сье абапье и прочие любители подглядывать за страданиями! Представляю вашему вниманию очередной результат танцев с бубенцами. Который в этот раз будет чуть менее бесполезным. И (быть может) сэкономит время какому-нибудь заблудившемуся \u003cstrong\u003eSAP\u003c/strong\u003e-кодерасту.\u003c/p\u003e\n\u003cp\u003eИногда хочется выть от боли, когда в очередной раз появляются требования выгрузки данных из стандартных или квази-стандартных отчетов SAP. Которые зачастую вообще не предусматривают какой-либо экспорт или расширение.\u003c/p\u003e\n\u003cp\u003eДальше будет \u003cstrong\u003eABAP\u003c/strong\u003e и рассказывания о подноготной \u003cstrong\u003eSAP ERP\u003c/strong\u003e. Если у вас нет вуайеристских наклонностей или профессионального интереса в дальнейшем тексте, то рекомендую закрыть страницу, чтобы не испытать экзистенциальный ужас от полученной информации.\u003c/p\u003e\n\u003cp\u003eЧто ж, погружаемся, товарищи. Так сказать, пристегните ремни. Будет немного трясти \u003cdel\u003eи пованивать\u003c/del\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"../assets/blog/export-data-to-sap-spool/dipping.jpg\" alt=\"Погружаемся!\"\u003e\u003c/p\u003e\n\u003ch2\u003eПоехали.\u003c/h2\u003e\n\u003cp\u003eИтак, представим ситуацию: Вы сидите, неспешно ковыряете код. И тут прилетает задача —  достать данные из древнего отчета, нарисованного в \u003cstrong\u003eSAP Query\u003c/strong\u003e через \u003cstrong\u003eReport painter\u003c/strong\u003e; их немного обработать и отдать в другой интерфейс.\u003c/p\u003e\n\u003cp\u003eКазалось бы, что может быть сложного? Ну, например, всё. \u003c/p\u003e\n\u003ch3\u003eSAP Query (далее SQ)\u003c/h3\u003e\n\u003cp\u003eЭто сраный \u003cstrong\u003eSAP Query\u003c/strong\u003e. Пользователь мышой натыкивает нужные ему поля и форму отчета, а на выходе получает готовый отчет. Софтина сама собирает ABAP-программу по конфигу. Класна? Нет. \u003c/p\u003e\n\u003cp\u003eКаждая дальнейшая правка отчета в пользовательской морде пересобирает целиком \u003cem\u003eвсё\u003c/em\u003e. Более того, никто не гарантирует, что программа пересоберется с тем же техническим названием. Ну и при переезде правок по ландшафту дев-тест-прод -\u003e будет генерироваться разное название.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eВывод:\u003c/strong\u003e Вписаться в код отчета и вытащить данные перед их отображением —  не получится. Юзверь перезатрёт всё прямзавтра. А скорее всего —  вчера.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"../assets/blog/export-data-to-sap-spool/userflow.jpg\" alt=\"userflow\"\u003e\u003c/p\u003e\n\u003ch3\u003eReport Painter\u003c/h3\u003e\n\u003cp\u003eЯ нарвался на \u003cem\u003e\"не совсем классическое\"\u003c/em\u003e  использование \u003cstrong\u003eSQ\u003c/strong\u003e! Данные выводятся не напрямую, а проходят через \u003cem\u003e\"прослойку отрисовщика\"\u003c/em\u003e (Report Painter). И воспользоваться стандартным FM \u003cstrong\u003eRSAQ_REMOTE_QUERY_CALL\u003c/strong\u003e, увы, не выйдет. \u003c/p\u003e\n\u003cp\u003eТ.к. для заданного отчета вообще нет таких параметров, как \u003cem\u003e\"имя запроса\"\u003c/em\u003e и  \u003cem\u003e\"группа пользователей\"\u003c/em\u003e. Просто н\u003cstrong\u003eе\u003c/strong\u003eчего подавать в аргументы функции.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eВывод:\u003c/strong\u003e Увы, воспользоваться предусмотренными FM невозможно. \u003c/p\u003e\n\u003ch3\u003eЭто, мать вашу, не ALV\u003c/h3\u003e\n\u003cp\u003eА жаль. При отображении, ALV-таблицы постят свои мета-(и не очень мета)данные в глобальный скоуп сессии пользователя. И оттуда элементарно вытащить что угодно. Например, вот так:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-abap\"\u003e\u003ccode class=\"language-abap\"\u003ecl_salv_bs_runtime_info\u003cspan class=\"token token-operator punctuation\"\u003e=\u003e\u003c/span\u003eset\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eEXPORTING\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edisplay\u003c/span\u003e  \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e abap_false  \n\t\t\t\t\t\t\t\t\t\tmetadata \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e abap_true  \n\t\t\t\t\t\t\t\t\t\t\u003cspan class=\"token keyword\"\u003edata\u003c/span\u003e     \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e abap_true \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\t\t\t\t\t\t\t\t\t\t\n\u003cspan class=\"token eol-comment comment\"\u003e\" submit report and return\u003c/span\u003e\n\ncl_salv_bs_runtime_info\u003cspan class=\"token token-operator punctuation\"\u003e=\u003e\u003c/span\u003eget_data_ref\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eIMPORTING\u003c/span\u003e r_data \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e ro_data \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\n\u003cspan class=\"token eol-comment comment\"\u003e\" do with ro_data what you want\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3\u003eНе работает ... exporting list to memory\u003c/h3\u003e\n\u003cp\u003eНеобъяснимо, но факт. Несмотря на то, что SQ-отчеты де-факто рендерят стандартный лист!\u003c/p\u003e\n\u003cp\u003eПопытка экспортировать таким способом просто подвешивает основной поток выполнения и ничего не делает. Чому? Об этом знает только аллах. \u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-abap\"\u003e\u003ccode class=\"language-abap\"\u003e\u003cspan class=\"token keyword\"\u003esubmit\u003c/span\u003e prog \u003cspan class=\"token keyword\"\u003eand\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eexporting\u003c/span\u003e \u003cspan class=\"token keyword\"\u003elist\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eto\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ememory\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token eol-comment comment\"\u003e\" not working\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3\u003eНо выход всегда есть\u003c/h3\u003e\n\u003cp\u003e\u003cem\u003e(особенно, если вы живёте достаточно высоко)\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eДавайте подумаем, \u003cstrong\u003eчто может быть общего\u003c/strong\u003e между матричными принтерами, и решением моей задачи? \u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"../assets/blog/export-data-to-sap-spool/printer.jpeg\" alt=\"printer\"\u003e\u003c/p\u003e\n\u003cp\u003eДа, теми самыми принтерами с рулоном ленты. Которые буквально печатают \"стуча\" по бумаге, как старые печатающие машинки. И которые могут использовать только \u003cem\u003eASCII\u003c/em\u003e символы. \u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eА то\u003c/strong\u003e, что \u003cstrong\u003eSAP\u003c/strong\u003e \u003cem\u003e(Эдакая древняя громадина)\u003c/em\u003e из коробки поддерживает \u003cem\u003eASCII\u003c/em\u003e-фикацию и печать всех отчетов, которые отрисовываются \"стандартным\" способом. Так это же то, что мне нужно! Такой текст будет элементарно распарсить после получения.\u003c/p\u003e\n\u003cp\u003eДостаточно дёрнуть печать отчета, и вовремя подхватить \u003cem\u003eASCII\u003c/em\u003e-фицированный документ кодом! Получается что-то вроде этого:\u003c/p\u003e\n\u003cp\u003eСоздаём фоновое задание, где будет выполняться рендеринг и попытка печати.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-abap\"\u003e\u003ccode class=\"language-abap\"\u003e\u003cspan class=\"token keyword\"\u003eCALL\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eFUNCTION\u003c/span\u003e \u003cspan class=\"token string\"\u003e'JOB_OPEN'\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eEXPORTING\u003c/span\u003e\n    jobname          \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e kv_job_name\n  \u003cspan class=\"token keyword\"\u003eIMPORTING\u003c/span\u003e\n    jobcount         \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e lv_jobcount\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eСобираем параметры печати. Нам нужно попросить программу напечататься сразу же после выполнения, и не показывать никаких диалогов. \u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-abap\"\u003e\u003ccode class=\"language-abap\"\u003e\u003cspan class=\"token keyword\"\u003eCALL\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eFUNCTION\u003c/span\u003e \u003cspan class=\"token string\"\u003e'GET_PRINT_PARAMETERS'\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eEXPORTING\u003c/span\u003e\n    list_name      \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'TEST'\u003c/span\u003e\n    list_text      \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'SUBMIT this fucking program TO SAP-SPOOL'\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eimmediately\u003c/span\u003e    \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e abap_true\n    no_dialog      \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e abap_true\n  \u003cspan class=\"token keyword\"\u003eIMPORTING\u003c/span\u003e\n    out_parameters \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e ls_params\n    \u003cspan class=\"token keyword\"\u003evalid\u003c/span\u003e          \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e lv_valid\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eВызываем программу в фоне со всеми собранными параметрами. Конструкция \u003cstrong\u003eto sap-spool ... without spool\u003c/strong\u003e нисколько сап не смущает. И вполне корректно отрабатывает. \u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-abap\"\u003e\u003ccode class=\"language-abap\"\u003e\u003cspan class=\"token keyword\"\u003eSUBMIT\u003c/span\u003e program_technical_name \u003cspan class=\"token keyword\"\u003eUSING\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eSELECTION-SET\u003c/span\u003e \u003cspan class=\"token string\"\u003e'VAR1'\u003c/span\u003e \n      \u003cspan class=\"token keyword\"\u003eTO\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eSAP-SPOOL\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eSPOOL\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ePARAMETERS\u003c/span\u003e ls_params \n      \u003cspan class=\"token keyword\"\u003eWITHOUT\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eSPOOL\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eDYNPRO\u003c/span\u003e \n      \u003cspan class=\"token keyword\"\u003eVIA\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eJOB\u003c/span\u003e kv_job_name \u003cspan class=\"token keyword\"\u003eNUMBER\u003c/span\u003e lv_jobcount \n      \u003cspan class=\"token keyword\"\u003eAND\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eRETURN\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eТак, программу мы вызвали, теперь придется костылём дожидаться завершения фоновой задачи. Никаких ивентов и коллбэков тут нет. \u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-abap\"\u003e\u003ccode class=\"language-abap\"\u003e\u003cspan class=\"token eol-comment comment\"\u003e\" Костыль ожидания завершения асинхронной жобы\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eWHILE\u003c/span\u003e ls_empty \u003cspan class=\"token keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eINITIAL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eWAIT\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eUP\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eTO\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eSINGLE\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eFROM\u003c/span\u003e tbtco \u003cspan class=\"token keyword\"\u003eINTO\u003c/span\u003e ls_empty \u003cspan class=\"token keyword\"\u003eWHERE\u003c/span\u003e jobname \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e kv_job_name \u003cspan class=\"token keyword\"\u003eAND\u003c/span\u003e jobcount \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e lv_jobcount \u003cspan class=\"token keyword\"\u003eAND\u003c/span\u003e status \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'F'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eENDWHILE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eНу, собственно, всё. Фоновая задача завершена. В системе уже хранятся отрендеренные данные, и нам остаётся лишь их подхватить. \u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-abap\"\u003e\u003ccode class=\"language-abap\"\u003e\u003cspan class=\"token keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eSINGLE\u003c/span\u003e listident\n  \u003cspan class=\"token keyword\"\u003eFROM\u003c/span\u003e tbtcp\n  \u003cspan class=\"token keyword\"\u003eINTO\u003c/span\u003e lv_listident\n  \u003cspan class=\"token keyword\"\u003eWHERE\u003c/span\u003e jobname \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e kv_job_name\n    \u003cspan class=\"token keyword\"\u003eAND\u003c/span\u003e jobcount \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e lv_jobcount\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n \n\u003cspan class=\"token keyword\"\u003eCHECK\u003c/span\u003e lv_listident \u003cspan class=\"token keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eINITIAL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n \nlv_rqident \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e lv_listident\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n \n\u003cspan class=\"token keyword\"\u003eCALL\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eFUNCTION\u003c/span\u003e \u003cspan class=\"token string\"\u003e'RSPO_RETURN_ABAP_SPOOLJOB'\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eEXPORTING\u003c/span\u003e\n    rqident              \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e lv_rqident\n  \u003cspan class=\"token keyword\"\u003eTABLES\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ebuffer\u003c/span\u003e               \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e lt_buffer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eВ результате получаем внутрённюю таблицу \u003cstrong\u003elt_buffer\u003c/strong\u003e из строк отчета. Её элементарно разбирать на куски, и вытаскивать нужные нам значения.\u003c/p\u003e\n\u003cp\u003eСтолбцы в такой таблице разделены символом вертикальной черты '|' и ничего не стоит распарсить поля по отдельности. \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://gist.github.com/JustAddAcid/450d4cd5f1069dbac61c3e842508b969\"\u003eПолный код на github gists здесь\u003c/a\u003e\u003c/p\u003e\n\u003ciframe frameborder=\"0\" style=\"border:none;width:100%;height:180px;\" width=\"100%\" height=\"180\" src=\"https://music.yandex.ru/iframe/#track/57987781/8763763\"\u003eСлушайте \u003ca href='https://music.yandex.ru/album/8763763/track/57987781'\u003eWhat the Fuck\u003c/a\u003e — \u003ca href='https://music.yandex.ru/artist/7756103'\u003eRHODAMINE\u003c/a\u003e на Яндекс.Музыке\u003c/iframe\u003e\n\u003cp\u003e\u003ca href=\"/tags/abap\"\u003e#abap\u003c/a\u003e \u003ca href=\"/tags/%D1%82%D0%B0%D0%BD%D1%86%D1%8B_%D1%81_%D0%B1%D1%83%D0%B1%D0%BD%D0%BE%D0%BC\"\u003e#танцы\u003cem\u003eс\u003c/em\u003eбубном\u003c/a\u003e\u003c/p\u003e\n","ogImage":{"url":"/assets/blog/export-data-to-sap-spool/background.jpg"},"coverImage":"/assets/blog/export-data-to-sap-spool/background.jpg","issueId":"18"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"export-data-to-sap-spool"},"buildId":"WGLPwn0mPPHoFJAY34UX7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>