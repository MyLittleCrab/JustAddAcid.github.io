<!DOCTYPE html><html lang="ru"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Nosoff.info — personal blog"/><title>Автоматизируем деплой статического сайта с помощью CircleCI</title><meta property="og:image" content="/assets/blog/circleci/cover.png"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/8989f9f4657d19f0fcdb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8989f9f4657d19f0fcdb.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dab348d518a0e6702e4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dab348d518a0e6702e4.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/framework-92300432a1172ef1338b.js" defer=""></script><script src="/_next/static/chunks/main-a3a79aff3ff232b41814.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f98b93c1570ecf70d9fa.js" defer=""></script><script src="/_next/static/chunks/853-ae4f3fbc7686be6d8798.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-27720eb20c91d7796fb9.js" defer=""></script><script src="/_next/static/WGLPwn0mPPHoFJAY34UX7/_buildManifest.js" defer=""></script><script src="/_next/static/WGLPwn0mPPHoFJAY34UX7/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="min-h-screen"><main><div class="container mx-auto px-5"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8"><a class="hover:underline" href="/">Nosoff.info</a></h2><article class="mb-32"><h1 class="screenreader">Автоматизируем деплой статического сайта с помощью CircleCI</h1><div class="hidden md:block md:mb-12"><a class="flex items-center" href="https://github.com/JustAddAcid"><img src="https://avatars3.githubusercontent.com/u/21103635?s=120&amp;v=4" class="w-12 h-12 rounded-full mr-4" alt="Roman A. Nosov"/><div class="text-xl font-bold">Roman A. Nosov</div></a></div><div class="mb-8 md:mb-16 -mx-5 sm:mx-0"><div class="-mx-5 sm:mx-0"><img src="/assets/blog/circleci/cover.png" alt="Cover Image for Автоматизируем деплой статического сайта с помощью CircleCI" class="shadow-small"/></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><a class="flex items-center" href="https://github.com/JustAddAcid"><img src="https://avatars3.githubusercontent.com/u/21103635?s=120&amp;v=4" class="w-12 h-12 rounded-full mr-4" alt="Roman A. Nosov"/><div class="text-xl font-bold">Roman A. Nosov</div></a></div><div class="mb-6 text-lg"><time dateTime="2020-05-05T16:12:07.322Z">May	5, 2020</time></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__1x9gM"><p>С хостингом и комментариями немного разобрались. Теперь заставим нашу шайтан-машину автоматически пересобирать сайт, если в .md шаблонах произошли какие-то изменения. Потому что нет никакого желания <strong>каждый раз</strong> после минимального изменения статьи делать руками билд, перетаскивать собранные <em>html</em> страницы в другой репозиторий и коммитить. Естественно, это можно и нужно оптимизировать. В качестве подопытного кролика сегодня выступает сервис <em>CircleCi</em>, у которого достаточно удобный бесплатный тариф, которого нам будет более чем достаточно.</p>
<p><strong>Для тех, кто в танке и никогда об этом не слышал:</strong> <em>CircleCi</em> — это облачный сервис для continuous integration. Умеет следить за изменениями в Git-репозиториях и пересобирать билды приложений, прогонять тесты и т.д. Тестить в статическом блоге толком нечего, а вот функция собирать билды нам как раз пригодится.</p>
<p><strong>Для бородатых админов:</strong> я не большой спец в CI, так что, если код будет не совсем согласован с общепринятыми Best-Practice, то прошу меня извинить и прошу написать в комментариях о том, как это сделать лучше и безопасней.</p>
<h2>Автоматизировали, автоматизировали, да не выавтоматизировали</h2>
<p><img src="../assets/blog/circleci/meme.jpeg" alt="If you never deploy, your deploy never falls"></p>
<p>Итак, поехали. Для начала, нужно определиться, что за нас должна делать шайтан-машина.
Предварительный алгоритм:</p>
<ol>
<li>Скрипт проверяет все .md файлы с постами на предмет того, создана ли для него issue на GitHub (для реализации комментариев, <a href="./issue-comments-github">о которых здесь</a>)</li>
<li>Если к .md файлу не привязана issue, то создать, и записать в файл issue id. Сделать коммит и пуш</li>
<li>Сделать билд в статический html</li>
<li>Положить файлы билда в репозиторий с github pages (JustAddAcid.github.io). Сделать коммит и пуш</li>
</ol>
<h2>Реализация — скрипт проверки и привязки issue</h2>
<p>В package.json объявим скрипт issues, который запускает файл issues.mjs из корня. </p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"dev"</span><span class="token operator">:</span> <span class="token string">"next"</span><span class="token punctuation">,</span>
    <span class="token string">"build"</span><span class="token operator">:</span> <span class="token string">"next build"</span><span class="token punctuation">,</span>
    <span class="token string">"start"</span><span class="token operator">:</span> <span class="token string">"next start"</span><span class="token punctuation">,</span>
    <span class="token string">"export"</span><span class="token operator">:</span> <span class="token string">"next export"</span><span class="token punctuation">,</span>
    <span class="token string">"issues"</span><span class="token operator">:</span> <span class="token string">"node issues.mjs"</span> <span class="token comment">//  &#x3C;--- </span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>В issues.mjs следующая логика: во всех файлах с постами скрипт ищет подстроку %%ISSUЕ_ID%%. И если находит, то создаёт новое GitHub Issue, а его ID подставляет вместо %%ISSUЕ_ID%%.</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> issueNotCreatedYet <span class="token operator">=</span> <span class="token string">'%%ISSUЕ_ID%%'</span><span class="token punctuation">,</span>
      notCreatedRegExp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>issueNotCreatedYet<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span>

<span class="token comment">//...</span>

<span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> filesInDir <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readdirSync</span><span class="token punctuation">(</span>postsDir<span class="token punctuation">)</span> <span class="token comment">// получаем имена файлов в директории</span>
    
    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fileName <span class="token keyword">of</span> filesInDir<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> filePath <span class="token operator">=</span> postsDir <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> fileName<span class="token punctuation">,</span>
              fileText <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              nameWithoutExtension <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>fileText<span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>issueNotCreatedYet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
            <span class="token keyword">const</span> issueId <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">createIssue</span><span class="token punctuation">(</span>nameWithoutExtension<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  newText <span class="token operator">=</span> fileText<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span>notCreatedRegExp<span class="token punctuation">,</span> issueId<span class="token punctuation">)</span>
            fs<span class="token punctuation">.</span><span class="token method function property-access">writeFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> newText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>А функция, createIssue представляет собой post-запрос в github api</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">createIssue</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">name</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.github.com/repos/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>githubUser<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetRepo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/issues</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        method<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
        body<span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token operator">:</span> <span class="token string">'Comments: '</span> <span class="token operator">+</span> name<span class="token punctuation">,</span>
            body<span class="token operator">:</span> postPrefix <span class="token operator">+</span> name
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">'Accept'</span> <span class="token operator">:</span> <span class="token string">'application/vnd.github.v3.html+json'</span><span class="token punctuation">,</span>
            <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
            <span class="token string">'Authorization'</span><span class="token operator">:</span> <span class="token function">basicAuthHeader</span><span class="token punctuation">(</span>githubUser<span class="token punctuation">,</span> password<span class="token punctuation">)</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> createdIssue <span class="token operator">=</span> <span class="token keyword control-flow">await</span> response<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> createdIssue<span class="token punctuation">.</span><span class="token property-access">number</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p><em>В примере выше для авторизации на GitHub используется basic auth header, который сейчас является <strong>deprecated</strong>. Такая возможность авторизоваться будет <strong>удалена</strong> в ноябре 2020. <a href="https://developer.github.com/changes/2020-02-14-deprecating-password-auth/" title="Deprecating password authentication">Больше информации здесь.</a></em></p>
<p>Теперь мне нужно запомнить, что всегда, когда я хочу, чтобы система автоматически создала issue, нужно вместо ID созданной руками issue писать директиву %%ISSUЕ_ID%%</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    excerpt<span class="token operator">:</span> <span class="token string">'С хостингом и комментариями немного разобрались. Теперь заставим нашу шайтан-машину пересобирать сайт, если в .md шаблонах произошли какие-то изменения'</span>
    coverImage<span class="token operator">:</span> <span class="token string">'/assets/blog/circleci/cover.png'</span>
    date<span class="token operator">:</span> <span class="token string">'2020-05-05T16:12:07.322Z'</span>
    issueId<span class="token operator">:</span> <span class="token string">'%%ISSUЕ_ID%%'</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2>Реализация — конфиг CircleCi</h2>
<p>Конфиг <em>CircleCi</em> представляет собой <strong>config.yml</strong> файл в директории <strong>.circleci</strong> в корне вашего репозитория. Сам конфиг-файл содержит описания шагов, которые должен сделать сервер, чтобы задеплоить ваше приложение и/или запустить тесты. </p>
<p>Но для начала нужно примерно представить, какие действия (shell-команды) нам всё-таки нужно проделать. У меня получилось как-то так:</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Представляемся гиту</span>
<span class="token function">git</span> config --global user.email <span class="token variable">$GH_EMAIL</span>
<span class="token function">git</span> config --global user.name <span class="token variable">$CIRCLE_USERNAME</span>

<span class="token comment"># Запускаем скрипт проверки issues</span>
<span class="token function">npm</span> run issues
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">git</span> status --porcelain<span class="token variable">`</span></span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token comment"># Если мы изменили какие-то файлы — делаем коммит. </span>
  <span class="token comment"># А деплой будем делать в следующем таске, которые запустится при коммите</span>
  <span class="token function">git</span> <span class="token function">add</span> -A
  <span class="token function">git</span> commit -m <span class="token string">"Automated issues creation: <span class="token variable">${CIRCLE_SHA1}</span>"</span>
  <span class="token function">git</span> push
  <span class="token builtin class-name">echo</span> <span class="token string">"Pushed changes in current repo. Deploy in next task"</span>
  circleci-agent step <span class="token function">halt</span>
<span class="token keyword">fi</span>

<span class="token function">npm</span> run build

<span class="token comment"># Клонируем репозиторий сайта во временную папку и удаляем лишние директории</span>
<span class="token function">git</span> clone <span class="token variable">$TARGET_REPO_URL</span> targetDirectory
<span class="token builtin class-name">cd</span> ./targetDirectory/
<span class="token function">rm</span> -rf ./_next
<span class="token function">rm</span> -rf ./assets
<span class="token function">rm</span> -rf ./favicon
<span class="token function">rm</span> -rf ./posts
<span class="token builtin class-name">echo</span> <span class="token string">"deleting folders from <span class="token environment constant">$PWD</span>"</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token comment"># Инициируем экспорт проекта в статические html</span>
<span class="token function">npm</span> run <span class="token builtin class-name">export</span>
<span class="token comment"># Перекладываем html в наш репозиторий с сайтом</span>
/bin/cp ./out/* ./targetDirectory/ -R -f
<span class="token builtin class-name">cd</span> ./targetDirectory/
<span class="token builtin class-name">echo</span> <span class="token string">"commit in dir <span class="token environment constant">$PWD</span> into <span class="token variable">$TARGET_REPO_URL</span> repo"</span>
<span class="token function">git</span> <span class="token function">add</span> -A
<span class="token function">git</span> commit -m <span class="token string">"Automated deployment to GitHub Pages: <span class="token variable">${CIRCLE_SHA1}</span>"</span> --allow-empty
<span class="token function">git</span> push
</code></pre></div>
<p>Осталось натянуть этот скрипт на конфиг <strong>CircleCi</strong>:
Создаём в репозитории директорию <strong>.circleci</strong>, в ней файл <strong>config.yml</strong> с примерно следующим содержанием:</p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">2.1</span>
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">docker</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> circleci/node<span class="token punctuation">:</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> checkout
      <span class="token punctuation">-</span> <span class="token key atrule">restore_cache</span><span class="token punctuation">:</span>
          <span class="token key atrule">keys</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> v1<span class="token punctuation">-</span>dependencies<span class="token punctuation">-</span>
            <span class="token punctuation">-</span> v1<span class="token punctuation">-</span>dependencies<span class="token punctuation">-</span>
      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> Install dependencies
          <span class="token key atrule">command</span><span class="token punctuation">:</span> npm install
      <span class="token punctuation">-</span> <span class="token key atrule">save_cache</span><span class="token punctuation">:</span>
          <span class="token key atrule">paths</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> node_modules
          <span class="token key atrule">key</span><span class="token punctuation">:</span> v1<span class="token punctuation">-</span>dependencies<span class="token punctuation">-</span>
      <span class="token punctuation">-</span> <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="token scalar string">            git config --global user.email $GH_EMAIL</span>
<span class="token scalar string">            git config --global user.name $CIRCLE_USERNAME</span>

            <span class="token comment"># .... тот shell-скрипт, который представлен выше</span>
</code></pre></div>
<p>Остались мелочи:</p>
<ol>
<li>Зайти на сайт <a href="/tags/CircleCi">#CircleCi</a>, залогинившись своим аккаунтом GitHub</li>
<li>Во вкладке projects выбрать нужный репозиторий</li>
<li>Передать все используемые в скриптах переменные окружения</li>
<li>Создать user-key (для возможности коммита в репозиторий)</li>
</ol>
<p>В итоге, при каждом коммите в репозиторий будет просыпаться скрипт в CircleCi и пересобирать статический блог.</p>
<p>Ещё увидимся.</p>
<p><a href="/tags/javascript">#javascript</a> <a href="/tags/bash">#bash</a> </p>
</div></div></article><article class="mb-32 max-w-2xl mx-auto"><hr class="mb-5"/><h2 class="text-2xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-center">Комментарии</h2><div class="md:flex p-6">Loading...</div><a href="https://github.com/JustAddAcid/JustAddAcid.github.io/issues/7" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-400 rounded shadow mt-2 inline-block">Добавить комментарий</a></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Автоматизируем деплой статического сайта с помощью CircleCI","date":"2020-05-05T16:12:07.322Z","slug":"circle-ci","author":{"name":"Roman A. Nosov","picture":"https://avatars3.githubusercontent.com/u/21103635?s=120\u0026v=4","url":"https://github.com/JustAddAcid"},"content":"\u003cp\u003eС хостингом и комментариями немного разобрались. Теперь заставим нашу шайтан-машину автоматически пересобирать сайт, если в .md шаблонах произошли какие-то изменения. Потому что нет никакого желания \u003cstrong\u003eкаждый раз\u003c/strong\u003e после минимального изменения статьи делать руками билд, перетаскивать собранные \u003cem\u003ehtml\u003c/em\u003e страницы в другой репозиторий и коммитить. Естественно, это можно и нужно оптимизировать. В качестве подопытного кролика сегодня выступает сервис \u003cem\u003eCircleCi\u003c/em\u003e, у которого достаточно удобный бесплатный тариф, которого нам будет более чем достаточно.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eДля тех, кто в танке и никогда об этом не слышал:\u003c/strong\u003e \u003cem\u003eCircleCi\u003c/em\u003e — это облачный сервис для continuous integration. Умеет следить за изменениями в Git-репозиториях и пересобирать билды приложений, прогонять тесты и т.д. Тестить в статическом блоге толком нечего, а вот функция собирать билды нам как раз пригодится.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eДля бородатых админов:\u003c/strong\u003e я не большой спец в CI, так что, если код будет не совсем согласован с общепринятыми Best-Practice, то прошу меня извинить и прошу написать в комментариях о том, как это сделать лучше и безопасней.\u003c/p\u003e\n\u003ch2\u003eАвтоматизировали, автоматизировали, да не выавтоматизировали\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"../assets/blog/circleci/meme.jpeg\" alt=\"If you never deploy, your deploy never falls\"\u003e\u003c/p\u003e\n\u003cp\u003eИтак, поехали. Для начала, нужно определиться, что за нас должна делать шайтан-машина.\nПредварительный алгоритм:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eСкрипт проверяет все .md файлы с постами на предмет того, создана ли для него issue на GitHub (для реализации комментариев, \u003ca href=\"./issue-comments-github\"\u003eо которых здесь\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eЕсли к .md файлу не привязана issue, то создать, и записать в файл issue id. Сделать коммит и пуш\u003c/li\u003e\n\u003cli\u003eСделать билд в статический html\u003c/li\u003e\n\u003cli\u003eПоложить файлы билда в репозиторий с github pages (JustAddAcid.github.io). Сделать коммит и пуш\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eРеализация — скрипт проверки и привязки issue\u003c/h2\u003e\n\u003cp\u003eВ package.json объявим скрипт issues, который запускает файл issues.mjs из корня. \u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token string\"\u003e\"scripts\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"dev\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"next\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"next build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"start\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"next start\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"export\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"next export\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"issues\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"node issues.mjs\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e//  \u0026#x3C;--- \u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eВ issues.mjs следующая логика: во всех файлах с постами скрипт ищет подстроку %%ISSUЕ_ID%%. И если находит, то создаёт новое GitHub Issue, а его ID подставляет вместо %%ISSUЕ_ID%%.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e issueNotCreatedYet \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'%%ISSUЕ_ID%%'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      notCreatedRegExp \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRegExp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eissueNotCreatedYet\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'g'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e//...\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003emain\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e filesInDir \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e fs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ereaddirSync\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epostsDir\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// получаем имена файлов в директории\u003c/span\u003e\n    \n    \u003cspan class=\"token keyword control-flow\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e fileName \u003cspan class=\"token keyword\"\u003eof\u003c/span\u003e filesInDir\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e filePath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e postsDir \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fileName\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n              fileText \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e fs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ereadFileSync\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efilePath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etoString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n              nameWithoutExtension \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e fileName\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esplit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'.'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \n        \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efileText\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eincludes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eissueNotCreatedYet\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \n            \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e issueId \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateIssue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enameWithoutExtension\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                  newText \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e fileText\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ereplace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enotCreatedRegExp\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e issueId\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            fs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ewriteFileSync\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efilePath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e newText\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eА функция, createIssue представляет собой post-запрос в github api\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003ecreateIssue\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token parameter\"\u003ename\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e url \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003ehttps://api.github.com/repos/\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003egithubUser\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e/\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003etargetRepo\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e/issues\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e response \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eurl\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        method\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'post'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        body\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estringify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            title\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Comments: '\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e name\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            body\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e postPrefix \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e name\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        headers\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token string\"\u003e'Accept'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'application/vnd.github.v3.html+json'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token string\"\u003e'Content-Type'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'application/json'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token string\"\u003e'Authorization'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003ebasicAuthHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003egithubUser\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e password\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e createdIssue \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eawait\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ejson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e createdIssue\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003enumber\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etoString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cem\u003eВ примере выше для авторизации на GitHub используется basic auth header, который сейчас является \u003cstrong\u003edeprecated\u003c/strong\u003e. Такая возможность авторизоваться будет \u003cstrong\u003eудалена\u003c/strong\u003e в ноябре 2020. \u003ca href=\"https://developer.github.com/changes/2020-02-14-deprecating-password-auth/\" title=\"Deprecating password authentication\"\u003eБольше информации здесь.\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eТеперь мне нужно запомнить, что всегда, когда я хочу, чтобы система автоматически создала issue, нужно вместо ID созданной руками issue писать директиву %%ISSUЕ_ID%%\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    excerpt\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'С хостингом и комментариями немного разобрались. Теперь заставим нашу шайтан-машину пересобирать сайт, если в .md шаблонах произошли какие-то изменения'\u003c/span\u003e\n    coverImage\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/assets/blog/circleci/cover.png'\u003c/span\u003e\n    date\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'2020-05-05T16:12:07.322Z'\u003c/span\u003e\n    issueId\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'%%ISSUЕ_ID%%'\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eРеализация — конфиг CircleCi\u003c/h2\u003e\n\u003cp\u003eКонфиг \u003cem\u003eCircleCi\u003c/em\u003e представляет собой \u003cstrong\u003econfig.yml\u003c/strong\u003e файл в директории \u003cstrong\u003e.circleci\u003c/strong\u003e в корне вашего репозитория. Сам конфиг-файл содержит описания шагов, которые должен сделать сервер, чтобы задеплоить ваше приложение и/или запустить тесты. \u003c/p\u003e\n\u003cp\u003eНо для начала нужно примерно представить, какие действия (shell-команды) нам всё-таки нужно проделать. У меня получилось как-то так:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# Представляемся гиту\u003c/span\u003e\n\u003cspan class=\"token function\"\u003egit\u003c/span\u003e config --global user.email \u003cspan class=\"token variable\"\u003e$GH_EMAIL\u003c/span\u003e\n\u003cspan class=\"token function\"\u003egit\u003c/span\u003e config --global user.name \u003cspan class=\"token variable\"\u003e$CIRCLE_USERNAME\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Запускаем скрипт проверки issues\u003c/span\u003e\n\u003cspan class=\"token function\"\u003enpm\u003c/span\u003e run issues\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e`\u003c/span\u003e\u003cspan class=\"token function\"\u003egit\u003c/span\u003e status --porcelain\u003cspan class=\"token variable\"\u003e`\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# Если мы изменили какие-то файлы — делаем коммит. \u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# А деплой будем делать в следующем таске, которые запустится при коммите\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003egit\u003c/span\u003e \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e -A\n  \u003cspan class=\"token function\"\u003egit\u003c/span\u003e commit -m \u003cspan class=\"token string\"\u003e\"Automated issues creation: \u003cspan class=\"token variable\"\u003e${CIRCLE_SHA1}\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003egit\u003c/span\u003e push\n  \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Pushed changes in current repo. Deploy in next task\"\u003c/span\u003e\n  circleci-agent step \u003cspan class=\"token function\"\u003ehalt\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003enpm\u003c/span\u003e run build\n\n\u003cspan class=\"token comment\"\u003e# Клонируем репозиторий сайта во временную папку и удаляем лишние директории\u003c/span\u003e\n\u003cspan class=\"token function\"\u003egit\u003c/span\u003e clone \u003cspan class=\"token variable\"\u003e$TARGET_REPO_URL\u003c/span\u003e targetDirectory\n\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e ./targetDirectory/\n\u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf ./_next\n\u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf ./assets\n\u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf ./favicon\n\u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf ./posts\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"deleting folders from \u003cspan class=\"token environment constant\"\u003e$PWD\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Инициируем экспорт проекта в статические html\u003c/span\u003e\n\u003cspan class=\"token function\"\u003enpm\u003c/span\u003e run \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Перекладываем html в наш репозиторий с сайтом\u003c/span\u003e\n/bin/cp ./out/* ./targetDirectory/ -R -f\n\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e ./targetDirectory/\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"commit in dir \u003cspan class=\"token environment constant\"\u003e$PWD\u003c/span\u003e into \u003cspan class=\"token variable\"\u003e$TARGET_REPO_URL\u003c/span\u003e repo\"\u003c/span\u003e\n\u003cspan class=\"token function\"\u003egit\u003c/span\u003e \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e -A\n\u003cspan class=\"token function\"\u003egit\u003c/span\u003e commit -m \u003cspan class=\"token string\"\u003e\"Automated deployment to GitHub Pages: \u003cspan class=\"token variable\"\u003e${CIRCLE_SHA1}\u003c/span\u003e\"\u003c/span\u003e --allow-empty\n\u003cspan class=\"token function\"\u003egit\u003c/span\u003e push\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eОсталось натянуть этот скрипт на конфиг \u003cstrong\u003eCircleCi\u003c/strong\u003e:\nСоздаём в репозитории директорию \u003cstrong\u003e.circleci\u003c/strong\u003e, в ней файл \u003cstrong\u003econfig.yml\u003c/strong\u003e с примерно следующим содержанием:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003eversion\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e2.1\u003c/span\u003e\n\u003cspan class=\"token key atrule\"\u003ejobs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003ebuild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003edocker\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003eimage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e circleci/node\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003elatest\n    \u003cspan class=\"token key atrule\"\u003esteps\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e checkout\n      \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003erestore_cache\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003ekeys\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e v1\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edependencies\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e v1\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edependencies\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Install dependencies\n          \u003cspan class=\"token key atrule\"\u003ecommand\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e npm install\n      \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003esave_cache\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003epaths\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e node_modules\n          \u003cspan class=\"token key atrule\"\u003ekey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e v1\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edependencies\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003edeploy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Deploy\n          \u003cspan class=\"token key atrule\"\u003ecommand\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e\u003cspan class=\"token scalar string\"\u003e\u003c/span\u003e\n\u003cspan class=\"token scalar string\"\u003e            git config --global user.email $GH_EMAIL\u003c/span\u003e\n\u003cspan class=\"token scalar string\"\u003e            git config --global user.name $CIRCLE_USERNAME\u003c/span\u003e\n\n            \u003cspan class=\"token comment\"\u003e# .... тот shell-скрипт, который представлен выше\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eОстались мелочи:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eЗайти на сайт \u003ca href=\"/tags/CircleCi\"\u003e#CircleCi\u003c/a\u003e, залогинившись своим аккаунтом GitHub\u003c/li\u003e\n\u003cli\u003eВо вкладке projects выбрать нужный репозиторий\u003c/li\u003e\n\u003cli\u003eПередать все используемые в скриптах переменные окружения\u003c/li\u003e\n\u003cli\u003eСоздать user-key (для возможности коммита в репозиторий)\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eВ итоге, при каждом коммите в репозиторий будет просыпаться скрипт в CircleCi и пересобирать статический блог.\u003c/p\u003e\n\u003cp\u003eЕщё увидимся.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"/tags/javascript\"\u003e#javascript\u003c/a\u003e \u003ca href=\"/tags/bash\"\u003e#bash\u003c/a\u003e \u003c/p\u003e\n","ogImage":{"url":"/assets/blog/circleci/cover.png"},"coverImage":"/assets/blog/circleci/cover.png","issueId":"7"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"circle-ci"},"buildId":"WGLPwn0mPPHoFJAY34UX7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>